{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\n\nvar _s = $RefreshSig$();\n\nvar __jsx = React.createElement;\n\n/** @jsx jsx */\nimport React, { useEffect, useState } from \"react\";\nimport { jsx, Button } from \"theme-ui\";\nimport { toast } from \"react-toastify\";\nimport { makeStyles } from \"@material-ui/core/styles\";\nimport Backdrop from \"@material-ui/core/Backdrop\";\nimport { createUploadRequest } from \"../../Lib/createUploadRequest\";\nimport { getIsVariantFramed } from \"../../Lib/getIsVariantFramed\";\nimport { drawLayout } from \"../../Lib/drawLayout\";\nimport CheckoutCard from \"../CheckoutCard/CheckoutCard\";\nimport NextTabBtn from \"../NextTabBtn/NextTabBtn\";\nimport { getLazyUploader, resetPendingPromise } from \"../../Lib/getLazyUploader\";\ntoast.configure();\n\nfunction takeScreenshot(mapLocal) {\n  return new Promise(function (resolve, _) {\n    mapLocal.once(\"render\", function () {\n      resolve(mapLocal.getCanvas().toDataURL());\n    });\n    /* trigger render */\n\n    mapLocal.setBearing(mapLocal.getBearing());\n  });\n}\n\nexport default function Tab3Checkout(_ref) {\n  _s();\n\n  var map = _ref.map,\n      mapTitles = _ref.mapTitles,\n      activeLayout = _ref.activeLayout,\n      product = _ref.product,\n      activeMapStyle = _ref.activeMapStyle,\n      dataPrintfulVariant = _ref.dataPrintfulVariant;\n  var classes = useStyles();\n\n  var _useState = useState(false),\n      backdropOpen = _useState[0],\n      setBackdropOpen = _useState[1];\n\n  var _useState2 = useState(false),\n      isUploadPending = _useState2[0],\n      setIsUploadPending = _useState2[1];\n\n  var _useState3 = useState(\"\"),\n      imageBase64 = _useState3[0],\n      setImageBase64 = _useState3[1];\n\n  var _useState4 = useState(null),\n      imageSavedResponse = _useState4[0],\n      setImageSavedResponse = _useState4[1];\n\n  var _useState5 = useState(0),\n      percentageUpload = _useState5[0],\n      setPercentageUpload = _useState5[1];\n\n  useEffect(function () {\n    setImageSavedResponse(null);\n    resetPendingPromise();\n  }, [map, mapTitles, activeLayout, product, activeMapStyle]);\n\n  var createImage = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              return _context.abrupt(\"return\", new Promise(function (resolve, reject) {\n                takeScreenshot(map).then(function (data) {\n                  console.log(\"takeScreenshot DONE\");\n                  var image = new Image();\n\n                  image.onload = function () {\n                    var mergerCanvas = document.getElementById(\"canvas_merging\");\n                    mergerCanvas.setAttribute(\"height\", image.height);\n                    mergerCanvas.setAttribute(\"width\", image.width);\n                    var ctx = mergerCanvas.getContext(\"2d\");\n                    ctx.drawImage(image, 0, 0);\n                    drawLayout(ctx, {\n                      width: image.width,\n                      height: image.height,\n                      activeLayout: activeLayout,\n                      mapTitles: mapTitles,\n                      frameWidthKoef: getIsVariantFramed(product.variantId).frameWidth,\n                      product: product,\n                      isProductionPrint: true\n                    });\n                    resolve(mergerCanvas.toDataURL());\n                  };\n\n                  image.src = data;\n                });\n              }));\n\n            case 1:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    return function createImage() {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var progressCallbackFce = function progressCallbackFce(progressEvent) {\n    var percentCompleted = Math.round(progressEvent.loaded * 100 / progressEvent.total);\n    setPercentageUpload(percentCompleted);\n  };\n\n  var uploadImage = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n      var finalImgSrc, head, imgFileSizeMB, originalVarId, response;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.prev = 0;\n              setBackdropOpen(true);\n              setIsUploadPending(true);\n              _context2.next = 5;\n              return createImage();\n\n            case 5:\n              finalImgSrc = _context2.sent;\n              head = \"data:image/png;base64,\";\n              imgFileSizeMB = Math.round((finalImgSrc.length - head.length) * 3 / 4 / 1000000);\n              originalVarId = product.variantId;\n              console.log({\n                originalVarId: originalVarId\n              });\n              console.log({\n                finalImgSrc: finalImgSrc,\n                imgFileSizeMB: imgFileSizeMB\n              });\n              setImageBase64(finalImgSrc);\n              _context2.next = 14;\n              return createUploadRequest(finalImgSrc, progressCallbackFce);\n\n            case 14:\n              response = _context2.sent;\n              console.log(\"Ulozeni Response: \", {\n                response: response,\n                originalVarId: originalVarId,\n                prodId: product.variantId\n              });\n\n              if (!response.data.secure_url) {\n                _context2.next = 22;\n                break;\n              }\n\n              console.log(\"✅ successful upload!\");\n              toast(\"✔️ uloženo, můžete pokračovat\", {\n                type: \"success\"\n              });\n              setIsUploadPending(false);\n              setImageSavedResponse(response.data);\n              return _context2.abrupt(\"return\", response.data);\n\n            case 22:\n              _context2.next = 27;\n              break;\n\n            case 24:\n              _context2.prev = 24;\n              _context2.t0 = _context2[\"catch\"](0);\n              console.error(_context2.t0);\n\n            case 27:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, null, [[0, 24]]);\n    }));\n\n    return function uploadImage() {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  var lazyUploadImage = function lazyUploadImage() {\n    return getLazyUploader(function () {\n      return imageSavedResponse;\n    }, function () {\n      return uploadImage();\n    })();\n  };\n\n  var backdropClose = function backdropClose() {\n    setBackdropOpen(false);\n  };\n\n  return jsx(\"div\", {\n    sx: styles.container\n  }, jsx(\"div\", {\n    sx: styles.absoluteBtnWrap\n  }, jsx(NextTabBtn, {\n    onClick: function onClick() {\n      setBackdropOpen(true);\n      lazyUploadImage();\n    },\n    margin: \"20px 0px 75px\",\n    price: eval(\"\".concat(product.price, \" + \").concat(dataPrintfulVariant === null || dataPrintfulVariant === void 0 ? void 0 : dataPrintfulVariant.shipping.rate)) //TODO add big.js\n\n  }, \"Shrnut\\xED objedn\\xE1vky\")), jsx(\"img\", {\n    id: \"img_screen_shot\",\n    sx: styles.resultImage\n  }), jsx(Backdrop, {\n    className: classes.backdrop,\n    classes: {\n      root: classes.rootBackdrop // class name, e.g. `classes-nesting-root-x`\n\n    },\n    open: backdropOpen,\n    onClick: backdropClose\n  }, jsx(CheckoutCard, {\n    isUploadPending: isUploadPending,\n    setIsUploadPending: setIsUploadPending,\n    product: product,\n    mapTitles: mapTitles,\n    imageSavedResponse: imageSavedResponse,\n    imageBase64: imageBase64 // shippingInfoObject={shippingInfoObject}\n    // isShippingInfoLoading={isShippingInfoLoading}\n    ,\n    backdropClose: backdropClose,\n    percentageUpload: percentageUpload\n  })));\n}\n\n_s(Tab3Checkout, \"l5fj25k7wf1OpJtCsZKr14h62Bo=\", false, function () {\n  return [useStyles];\n});\n\n_c = Tab3Checkout;\nvar styles = {\n  container: {\n    margin: \"50px 0\",\n    \"& p\": {\n      fontFamily: \"Arial, sans-serif\",\n      margin: 0\n    }\n  },\n  payRow: {\n    padding: \"10px\",\n    width: \"100%\"\n  },\n  absoluteBtnWrap: {\n    position: \"fixed\",\n    top: \"85vh\",\n    left: \"0px\",\n    width: [\"100%\", \"100%\", \"100%\", \"40%\"]\n  },\n  resultImage: {\n    width: \"100%\",\n    backgroundColor: \"green\",\n    zIndex: 10\n  }\n};\nvar useStyles = makeStyles(function (theme) {\n  return {\n    backdrop: {\n      zIndex: \"10 !important\",\n      color: \"#fff\"\n    },\n    rootBackdrop: {\n      zIndex: \"12 !important\"\n    }\n  };\n});\n\nvar _c;\n\n$RefreshReg$(_c, \"Tab3Checkout\");","map":{"version":3,"sources":["/Users/petrhoskovec/Desktop/code/trip_map_staging/src/components/Tab3/tab3Checkout.js"],"names":["React","useEffect","useState","jsx","Button","toast","makeStyles","Backdrop","createUploadRequest","getIsVariantFramed","drawLayout","CheckoutCard","NextTabBtn","getLazyUploader","resetPendingPromise","configure","takeScreenshot","mapLocal","Promise","resolve","_","once","getCanvas","toDataURL","setBearing","getBearing","Tab3Checkout","map","mapTitles","activeLayout","product","activeMapStyle","dataPrintfulVariant","classes","useStyles","backdropOpen","setBackdropOpen","isUploadPending","setIsUploadPending","imageBase64","setImageBase64","imageSavedResponse","setImageSavedResponse","percentageUpload","setPercentageUpload","createImage","reject","then","data","console","log","image","Image","onload","mergerCanvas","document","getElementById","setAttribute","height","width","ctx","getContext","drawImage","frameWidthKoef","variantId","frameWidth","isProductionPrint","src","progressCallbackFce","progressEvent","percentCompleted","Math","round","loaded","total","uploadImage","finalImgSrc","head","imgFileSizeMB","length","originalVarId","response","prodId","secure_url","type","error","lazyUploadImage","backdropClose","styles","container","absoluteBtnWrap","eval","price","shipping","rate","resultImage","backdrop","root","rootBackdrop","margin","fontFamily","payRow","padding","position","top","left","backgroundColor","zIndex","theme","color"],"mappings":"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","sourcesContent":["/** @jsx jsx */\nimport React, { useEffect, useState } from \"react\";\nimport { jsx, Button } from \"theme-ui\";\nimport { toast } from \"react-toastify\";\nimport { makeStyles } from \"@material-ui/core/styles\";\nimport Backdrop from \"@material-ui/core/Backdrop\";\n\nimport { createUploadRequest } from \"../../Lib/createUploadRequest\";\nimport { getIsVariantFramed } from \"../../Lib/getIsVariantFramed\";\nimport { drawLayout } from \"../../Lib/drawLayout\";\nimport CheckoutCard from \"../CheckoutCard/CheckoutCard\";\nimport NextTabBtn from \"../NextTabBtn/NextTabBtn\";\n\nimport {\n  getLazyUploader,\n  resetPendingPromise,\n} from \"../../Lib/getLazyUploader\";\n\ntoast.configure();\n\nfunction takeScreenshot(mapLocal) {\n  return new Promise(function (resolve, _) {\n    mapLocal.once(\"render\", function () {\n      resolve(mapLocal.getCanvas().toDataURL());\n    });\n\n    /* trigger render */\n    mapLocal.setBearing(mapLocal.getBearing());\n  });\n}\n\nexport default function Tab3Checkout({\n  map,\n  mapTitles,\n  activeLayout,\n  product,\n  activeMapStyle,\n  dataPrintfulVariant,\n}) {\n  const classes = useStyles();\n\n  const [backdropOpen, setBackdropOpen] = useState(false);\n  const [isUploadPending, setIsUploadPending] = useState(false);\n  const [imageBase64, setImageBase64] = useState(\"\");\n  const [imageSavedResponse, setImageSavedResponse] = useState(null);\n  const [percentageUpload, setPercentageUpload] = useState(0);\n\n  useEffect(() => {\n    setImageSavedResponse(null);\n    resetPendingPromise();\n  }, [map, mapTitles, activeLayout, product, activeMapStyle]);\n\n  const createImage = async () => {\n    return new Promise((resolve, reject) => {\n      takeScreenshot(map).then(function (data) {\n        console.log(\"takeScreenshot DONE\");\n        var image = new Image();\n\n        image.onload = function () {\n          const mergerCanvas = document.getElementById(\"canvas_merging\");\n          mergerCanvas.setAttribute(\"height\", image.height);\n          mergerCanvas.setAttribute(\"width\", image.width);\n          var ctx = mergerCanvas.getContext(\"2d\");\n          ctx.drawImage(image, 0, 0);\n\n          drawLayout(ctx, {\n            width: image.width,\n            height: image.height,\n            activeLayout,\n            mapTitles,\n            frameWidthKoef: getIsVariantFramed(product.variantId).frameWidth,\n            product,\n            isProductionPrint: true,\n          });\n          resolve(mergerCanvas.toDataURL());\n        };\n\n        image.src = data;\n      });\n    });\n  };\n\n  const progressCallbackFce = (progressEvent) => {\n    var percentCompleted = Math.round(\n      (progressEvent.loaded * 100) / progressEvent.total\n    );\n\n    setPercentageUpload(percentCompleted);\n  };\n\n  const uploadImage = async () => {\n    try {\n      setBackdropOpen(true);\n      setIsUploadPending(true);\n      const finalImgSrc = await createImage();\n\n      const head = \"data:image/png;base64,\";\n\n      const imgFileSizeMB = Math.round(\n        ((finalImgSrc.length - head.length) * 3) / 4 / 1000000\n      );\n\n      let originalVarId = product.variantId;\n\n      console.log({ originalVarId });\n\n      console.log({ finalImgSrc, imgFileSizeMB });\n\n      setImageBase64(finalImgSrc);\n      const response = await createUploadRequest(\n        finalImgSrc,\n        progressCallbackFce\n      );\n      console.log(\"Ulozeni Response: \", {\n        response,\n        originalVarId,\n        prodId: product.variantId,\n      });\n\n      if (response.data.secure_url) {\n        console.log(\"✅ successful upload!\");\n        toast(\"✔️ uloženo, můžete pokračovat\", { type: \"success\" });\n\n        setIsUploadPending(false);\n        setImageSavedResponse(response.data);\n\n        return response.data;\n      }\n    } catch (e) {\n      console.error(e);\n    }\n  };\n\n  const lazyUploadImage = () => {\n    return getLazyUploader(\n      () => imageSavedResponse,\n      () => uploadImage()\n    )();\n  };\n\n  const backdropClose = () => {\n    setBackdropOpen(false);\n  };\n  return (\n    <div sx={styles.container}>\n      <div sx={styles.absoluteBtnWrap}>\n        <NextTabBtn\n          onClick={() => {\n            setBackdropOpen(true);\n            lazyUploadImage();\n          }}\n          margin=\"20px 0px 75px\"\n          price={eval(\n            `${product.price} + ${dataPrintfulVariant?.shipping.rate}`\n          )} //TODO add big.js\n        >\n          Shrnutí objednávky\n        </NextTabBtn>\n      </div>\n\n      <img id=\"img_screen_shot\" sx={styles.resultImage} />\n      <Backdrop\n        className={classes.backdrop}\n        classes={{\n          root: classes.rootBackdrop, // class name, e.g. `classes-nesting-root-x`\n        }}\n        open={backdropOpen}\n        onClick={backdropClose}\n      >\n        <CheckoutCard\n          isUploadPending={isUploadPending}\n          setIsUploadPending={setIsUploadPending}\n          product={product}\n          mapTitles={mapTitles}\n          imageSavedResponse={imageSavedResponse}\n          imageBase64={imageBase64}\n          // shippingInfoObject={shippingInfoObject}\n          // isShippingInfoLoading={isShippingInfoLoading}\n          backdropClose={backdropClose}\n          percentageUpload={percentageUpload}\n        />\n      </Backdrop>\n    </div>\n  );\n}\n\nconst styles = {\n  container: {\n    margin: \"50px 0\",\n    \"& p\": {\n      fontFamily: \"Arial, sans-serif\",\n      margin: 0,\n    },\n  },\n  payRow: {\n    padding: \"10px\",\n    width: \"100%\",\n  },\n  absoluteBtnWrap: {\n    position: \"fixed\",\n    top: \"85vh\",\n    left: \"0px\",\n    width: [\"100%\", \"100%\", \"100%\", \"40%\"],\n  },\n  resultImage: {\n    width: \"100%\",\n    backgroundColor: \"green\",\n    zIndex: 10,\n  },\n};\n\nconst useStyles = makeStyles((theme) => ({\n  backdrop: {\n    zIndex: \"10 !important\",\n    color: \"#fff\",\n  },\n  rootBackdrop: {\n    zIndex: \"12 !important\",\n  },\n}));\n"]},"metadata":{},"sourceType":"module"}